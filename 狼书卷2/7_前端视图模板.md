### 7.1 静态服务器

Node.js世界里的koa-static、http-server等模块和常见的Apache、Nginx功能类似。虽然线上做法是将静态资源到CDN上，利用CDN就近访问来提高访问效率，但实际开发环境和线上环境不完全一样，快速实现静态服务器功能对于开发者而言是非常重要的。

#### 7.1.1 public 目录

#### 7.1.2 实现原理

koa-static的核心部分是koa-send，koa-send是一个用于提供静态文件服务的Koa中间件。

简单来说，koa-static的原理为，根据文件后缀名设置默认的Content-Type，使之与浏览器渲染相匹配。

koa-serve-static相比之下性能更好一点。

如果大家细心观察现在各式各样的Web开发框架，会发现绝大部分框架都提供了public或www这样的目录来实现静态资源托管。

#### 7.1.3 静态服务

写作是一个培养思考能力和建立大局观的过程。

##### Hexo

Hexo是一个非常好的用于静态网站生成的Node.js模块。

Hexo的主要用途有以下3个：

- 编写个人博客
- 编写项目文档
- 编写demo

通过Hexo可以轻松地使用Markdown撰写文章，除了Markdown本身的语法，我们还可以使用Hexo提供的“标签插件”来快速插入特定形式的内容。

**1. 将Markdown文档编译成HTML片段**

**2. 通过模板编译将HTML片段嵌入布局**

Markdown虽然非常好用，但缺点也非常名，往往需要我们自己去定制一些东西。

**3. 发布**

Hexo中有支持在GitHub Pages上托管静态文件的插件，可以一键部署。部署到GitHub Pages上的操作非常简单，config.yml里有Git仓库对应的配置信息。

##### Surge

Surge.sh是一个专门为前端发布而提供的服务，它的特点是通过简单的命令行就可以完成发布。

它比CDN还要方便得多，对于生成静态页面等需求，用Surge时非常棒的。

##### docsify

docsify是一个基于Vue文档风格编写的非常好用的文档生成工具。

目录锚点一直是Markdown的一个痛点。

##### Gatsby

Gatsby有着更好的性能、更高的安全性、更低的扩展成本和更好的开发体验。

#### 7.1.4 预处理中间件

预编译处理已经成为提高工作效率的必备手段，而中间件是Koa的核心扩展机制，所以预编译和中间件二者结合能够发挥更好的作用，主要表现为在开发环境下可以有效简化构建环节。

除了在开发阶段，预编译类中间件是没有价值的。

### 7.2 使用模板引擎进行动态渲染

#### 7.2.1 模板引起原理

模板是一种采用复用思想实现的高级写法。其实现原理是，首先定义模板，然后在使用时将模板和数据一起编译成模板文件（在前端领域，模板一般会编译成HTML文件）。

编译（模板+数据）= HTML

模板的编译工具称为模板引擎。

##### EJS

- 通过fs.readFileSync读取模板文件，模板是固定的、不可变的，而数据可以在编译时填入，是可变的。
- 通过ejs.render方法进行编译后，结果是浏览器能够渲染的HTML代码。

##### Pug

Pug是一款高性能、简单易懂的模板引擎，在服务器端（Node.js）及客户端均被支持。习惯Pug的最好办法是，找一段已写好的HTML代码，用Pug重写以便。

**1. 性能**

升级后，Jade 2.0（即Pug）的编译性能得到了大幅度提升。

**2. 工具**

使用pug-cli或pug-server非常方便，他们可以自动将模板文件编译为HTML文件并提供HTTP静态服务。

**3. HTML2Jade**

可以通过HTML2Jade将已有的HTML代码转换为Pug模板，这是一个极为遍便利的技巧。

**4. 运行在浏览器端**

##### Nunjucks

Nunjucks应该是目前Node.js里最火的，也是最好的模板引起。

#### 7.2.2 模板引擎规则

以Pug为例：

**1. 标签简写**

**2. value的写法**

**3. 没有空行**

**4. 层级嵌套**

利用缩进来判断包含关系

**5. 变量**

**6. 常用指令if和each**

**7. 注释**

**8. 布局**

布局是模块化编程的产物。

在实现布局内容时还需要注意一下几点：

- extends指明了当前Pug页面继承自哪个Layout。
- 若block定义此处有模块，则模块的名字必须和Layout里定义的名字一致。

布局是最核心的概念，也是最实用的。

**9. include**

**10. 内嵌Script**

注意scrpit后面的“.”是必须要有的。

**少抱怨，多思考，未来更美好**

#### 7.2.3 Vue

模板语法是Vue非常有特色的特性。

##### 插写

插写时模板引擎里最常用的功能。Vue更加简单。

##### 指令

将指令和DOM绑定，对于逻辑控制而言是一个不错且不得不尝试的方案。

##### 布局

模板引擎虽然能够提高模板的复用度，并且做得也不错，但还是敌不过组件。

##### 事件

##### 双向绑定

##### computed

MVVM要关注视图和模型的联动，watch就是专门负责这件事的。computed和watch是类似的概念。

##### VNode

VNode是VDOM的核心模型。

技术是想通的，在一门精通技术的基础上去理解其他技术，这对学习者来说就会相对简单。

### 7.3 Webpack

Node.js作为前端基础设施，为前端发展提供了至关重要的助力。

#### 7.3.1 解决痛点

##### 1. 依赖管理

##### 2. 脚本加载

#### 7.3.2 模块规范

##### 1. CommonJS

##### 2. AMD

AMD规范是从CommonJS中逐渐分裂出来的，专门用于浏览器端。

##### 3. ES6 Modules

#### 7.3.3 模块加载器

由于JavaScript本身没有内置模块加载机制，所以需要依赖额外的容器才能实现，于是就有了模块加载器。

#### 7.3.4 模块打包器

能否在浏览器里运行Node.js模块代码呢？为了实现这一点，Browserify诞生了。

#### 7.3.5 Webpack详解

当Webpack处理应用程序时，它会递归构建一个依赖关系图，其中包含应用程序需要的每一个模块，然后将所有模块打包成一个或多个bundle文件

##### Webpack特性

代码分割是Webpack最重要的特性。

**1. css-loader**

在整个Webpack配置里，最核心的概念就是Loader。

**2. 代码分割和优化**

webpack-visualizer是Webpack的可视化资源分析工具。

##### Webpack原理

##### 设计前端开发工具

Ykit是去哪儿网开源的Node.js模块，它是对Webpack的封装。

总的来说，Ykit只是一个壳，真正的多样化构建依赖于插件。

### 7.4 前后端分离

《国富论》中提到，分工出现之后，劳动生产力得到了最大的增进，运用劳动时的熟练程度、技巧和判断力也得以加强。

#### 7.5 前端渲染

##### 7.5.1 客户端渲染

在前端可发工程中，主要的任务是编写源码并将源码打包编译后直接部署到CDN上。

##### 7.5.2 服务端渲染

服务端渲染是指采用React、Vue等现代框架，结合Node.js等服务器端环境完成页面渲染的一种开发方式。

引入服务器端渲染主要是为了实现以下3个目标：

- 搜索引擎优化：Search Engine Optimization，简称SEO。
- 页面加载性能提升。
- 架构升级。

阿里巴巴开源的Beidou是专注于React服务器端渲染的同构框架，它是一个很好的企业级同构渲染解决方案。

相比于客户端渲染，服务端渲染的难度加大了，开发者必须要掌握Egg.js相关知识。

##### 7.5.3 React服务器端渲染

另外一个著名的服务器端渲染框架是Next.js，它是一个纯粹为服务器端渲染应用开发的框架。

##### 7.5.4 Serverless时代的渲染层

React.js服务端渲染都是依赖Node.js Web应用的。

所有经验和最佳实践一定会沉淀出更简单的开发方式。

### 7.6 本章小结

在世俗的眼光里，Node.js工程师不会前端技能和前端工程师不会Node.js一样会被笑话。