### 1.1 Koa 简介

Koa是Node.js的下一代Web框架。异步流程控制特性。

我们可以把它理解成一个基于http模块进行封装的、提供中间件写法的微内核模块。

Koa v2使用显式的ctx作为上下文，语义更清晰。

在微服务架构下所有语言的机会都是一样的。

推荐用async函数作为中间件。

**Koa v2中新增一个ctx参数的最主要原因是，在编写Koa App使用了async箭头函数，在这种情况下，使用this时万万不能的。**

### 1.2 Koa手脚架

koa-generator是用于生成Koa项目骨架的生成器。

提供的功能：

- 生成项目骨架，继承必要的中间件。
- 约定目录结构。

项目骨架结构描述如下：

- app.js为入口。
- bin/www为启动入口
- 支持静态服务器，即public目录
- 支持routes路由目录
- 支持views视图目录
- 默认将Pug（之前名字是Jade）作为模板引擎。

**核心文件app.js**

主要包含4个部分：

- 中间件
- 路由
- 静态服务器
- 视图

赋予ctx.body不同类型的值会返回不同的结果。ctx.render是因为添加了koa-views中间件而绑定到ctx上的，也就是说，我们可以通过中间件在ctx上绑定我们要使用的功能。

public目录是为了方便开发而存在的，一般真正的项目有如下3类：

- 纯API项目，不需要public目录。
- 纯前后端分离项目，后端不需要public目录，前端需要。
- 需要public目录的项目，但会将public目录里的内容分发到CDN上。

编译（模板+数据）=HTML

中间件写法推荐使用async函数。

所有的服务端页面其实都是模板引擎。

### 1.3 Node.js Web框架演进

使用Node.js http模块来创建Web服务是最原始的方式。

任何重复的工作都应该被抽象。

- **app.use的中间件有顺序**。
- 中间件可分类：全局的和局部的（路由里生效的）。
- 中间件的定义方法是function(req, res) {}。



app.callback()里到底是什么呢？

- app是Koa对象。
- app.use里使用的Koa中间件写法。
- app.callback()把app.use里的内容转成了function(req, res){...}。

中间件是Web框架的核心。

Koa只提供中间件内核，不绑定任何中间件。

### 1.4 测试

不写测试的项目都不是好项目。

客观地讲，只有能写好测试的程序员才是真正的程序员。

- 对API、SDK的的理解会更加深入。
- 采用最小化问题思想可以更好地解决问题。
- 做好测试才能开发大型软件。
- 测试用例比程序员的大脑更客观。
- 在此时中使用CI（持续集成）可以让开发效率更高。

本书推荐AVA，简单地说，AVA是Mocha的替代品。



测试用例里用来验证的测试工具方法被称为断言。

ava 3.15.0所有测试文件需要以`test.js`结尾。

#### TDD与BDD

Test-Driven Development(TDD)即测试驱动开发，它是一种测试先于编写代码的思想用于指导软件开发。测试驱动开发时敏捷开发中的一项核心事件和技术，也是一种设计方法论。TDD的原理是在开发功能代码之前，先编写单元测试用例，测试代码确定需要编写什么产品代码。

Behavior Driven Development，行为驱动开发是一种敏捷开发的技术，它鼓励软件项目的开发者、QA和非技术人员或商业参与者之间的协作。它对TDD的理念进行了扩展，在TDD中侧重点偏向开发，通过测试用例来规范约束开发者编写出质量更高、bug更少的代码。而BDD更加侧重设计，其要求在设计测试用例的时候对系统进行定义，倡导使用通用的语言将系统的行为描述出来，将系统设计和测试用例结合起来，从而以此为驱动进行开发工作。

BDD的**通用语言**是一种近乎自然语言的描述软件的形式。传统的开发模式中，客户很难从技术层面理解问题，开发人员很难从业务需求考虑问题，基于这种通用语言形式可以尽可能的**避免客户和开发者在沟通上的障碍，实现客户和开发者同时定义系统的需求**。避免了因为理解需求不充分而带来的不必必要的工作量。

BDD描述的行为就像一个个的故事(**Story**)，系统业务专家、开发者、测试人员一起合作，分析软件的需求，然后将这些需求写成一个个的故事。开发者负责填充这些故事的内容，测试者负责检验这些故事的结果。通常，会使用一个故事的模板来对故事进行描述



测试生命周期是测试框架必备的特性，通过测试生命周期函数来体现。

为了保证测试代码的原子性，我们要为每个测试都准备好数据，然后测试其他内容。

各位读者一定要善用各种开源神器。